backend {
  default = "SlurmDocker"
  providers {
    SlurmDocker {
      actor-factory = "cromwell.backend.impl.sfs.config.ConfigBackendLifecycleActorFactory"
      config {
        # Cromwell-Slurm Communication
        job-id-regex = "Submitted batch job (\\d+)"
        check-alive = "squeue -j ${job_id}"
        kill = "scancel ${job_id}"

        # Convert Docker images to Singularity .sif
        runtime-attributes = """
        String? docker
        """
        # https://slurm.schedmd.com/sbatch.html
        submit-docker = """
        set -euo pipefail
        CACHE_DIR=$HOME/.singularity/cache
        mkdir -p $CACHE_DIR
        LOCK_FILE=$CACHE_DIR/singularity_pull_flock
        DOCKER_NAME=$(sed -e 's/[^A-Za-z0-9._-]/_/g' <<< ${docker})
        IMAGE=$CACHE_DIR/$DOCKER_NAME.sif
        (
          flock --verbose --exclusive --timeout 900 9 || exit 1
          if [ ! -e "$IMAGE" ]; then
            singularity build $IMAGE docker://${docker}
          fi
	) 9>$LOCK_FILE

        # Slurm Job Submission & Singularity execution instructions
        sbatch \
          -J ${job_name} \
          -D ${cwd} \
          -o ${cwd}/execution/stdout \
          -e ${cwd}/execution/stderr \
          --wrap "singularity exec --containall --bind ${cwd}:${docker_cwd} --bind /scratch.global/balay011:/scratch.global/balay011:ro --bind /projects/standard/aventeic/balay011:/projects/standard/aventeic/balay011:ro --bind /projects/standard/venteicher_30050/balay011$
        """
        # ... other configuration ...
        filesystems {
          local {
            # Removed 'hard-link' and 'copy' to force stable behavior
            localization: ["soft-link"]
            caching {
              duplication-strategy: ["soft-link"]
            }
            # This is critical for Singularity to follow links
            docker.allow-soft-links: true
          }
	}
      }
    }
  }
}